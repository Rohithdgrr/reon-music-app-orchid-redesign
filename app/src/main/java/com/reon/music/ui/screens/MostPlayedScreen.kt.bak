/*
 * REON Music App - Most Played Screen
 * Copyright (c) 2024 REON
 * Displays Most Played Songs with Minimal Padding
 */

package com.reon.music.ui.screens

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.itemsIndexed
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material.icons.outlined.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import coil.compose.AsyncImage
import com.reon.music.core.model.Song
import com.reon.music.ui.viewmodels.LibraryViewModel
import com.reon.music.ui.viewmodels.PlayerViewModel
import android.content.Intent
import androidx.compose.ui.platform.LocalContext

private val BackgroundWhite = Color(0xFFFFFFFF)
private val TextPrimary = Color(0xFF1C1C1C)
private val TextSecondary = Color(0xFF757575)
private val AccentRed = Color(0xFFE53935)
private val SurfaceLight = Color(0xFFFAFAFA)

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MostPlayedScreen(
    onBackClick: () -> Unit = {},
    libraryViewModel: LibraryViewModel = hiltViewModel(),
    playerViewModel: PlayerViewModel = hiltViewModel()
) {
    val uiState by libraryViewModel.uiState.collectAsState()
    val playerState by playerViewModel.playerState.collectAsState()
    val context = LocalContext.current
    
    var showSongOptions by remember { mutableStateOf(false) }
    var selectedSong by remember { mutableStateOf<Song?>(null) }
    var showAddToPlaylistDialog by remember { mutableStateOf(false) }
    var searchQuery by remember { mutableStateOf("") }
    var showSearch by remember { mutableStateOf(false) }
    
    // Sort by play count (most played first)
    val sortedSongs = remember(uiState.recentlyPlayed, searchQuery) {
        val filtered = if (searchQuery.isEmpty()) {
            uiState.recentlyPlayed
        } else {
            uiState.recentlyPlayed.filter { song ->
                song.title.contains(searchQuery, ignoreCase = true) ||
                song.artist.contains(searchQuery, ignoreCase = true)
            }
        }
        filtered.sortedByDescending { it.plays ?: 0 }
    }
    
    Scaffold(
        topBar = {
            if (showSearch) {
                SearchTopBar(
                    searchQuery = searchQuery,
                    onSearchQueryChanged = { searchQuery = it },
                    onCloseSearch = { 
                        showSearch = false
                        searchQuery = ""
                    }
                )
            } else {
                TopAppBar(
                    title = {
                        Text(
                            text = "Most Played (${uiState.recentlyPlayed.size})",
                            style = MaterialTheme.typography.headlineMedium,
                            fontWeight = FontWeight.Bold,
                            color = TextPrimary
                        )
                    },
                    navigationIcon = {
                        IconButton(onClick = onBackClick) {
                            Icon(
                                imageVector = Icons.Default.ArrowBack,
                                contentDescription = "Back",
                                tint = TextPrimary
                            )
                        }
                    },
                    actions = {
                        IconButton(onClick = { showSearch = true }) {
                            Icon(
                                imageVector = Icons.Outlined.Search,
                                contentDescription = "Search",
                                tint = TextPrimary
                            )
                        }
                        if (sortedSongs.isNotEmpty()) {
                            IconButton(onClick = { 
                                playerViewModel.enableRadioMode(sortedSongs)
                            }) {
                                Icon(
                                    imageVector = Icons.Default.Radio,
                                    contentDescription = "Radio Mode",
                                    tint = AccentRed
                                )
                            }
                        }
                    },
                    colors = TopAppBarDefaults.topAppBarColors(
                        containerColor = BackgroundWhite
                    )
                )
            }
        },
        containerColor = BackgroundWhite
    ) { paddingValues ->
        if (sortedSongs.isEmpty()) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(paddingValues),
                contentAlignment = Alignment.Center
            ) {
                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.Center
                ) {
                    Icon(
                        imageVector = Icons.Default.TrendingUp,
                        contentDescription = "No Most Played",
                        modifier = Modifier.size(64.dp),
                        tint = TextSecondary
                    )
                    Spacer(modifier = Modifier.height(16.dp))
                    Text(
                        text = "No Plays Yet",
                        style = MaterialTheme.typography.headlineSmall,
                        color = TextPrimary,
                        fontWeight = FontWeight.Bold
                    )
                    Text(
                        text = "Songs you play will appear here",
                        style = MaterialTheme.typography.bodyMedium,
                        color = TextSecondary,
                        modifier = Modifier.padding(horizontal = 20.dp)
                    )
                }
            }
        } else {
            LazyColumn(
                modifier = Modifier.fillMaxSize(),
                contentPadding = PaddingValues(horizontal = 4.dp, vertical = 8.dp)
            ) {
                itemsIndexed(sortedSongs) { index, song ->
                    MostPlayedSongItem(
                        song = song,
                        rank = index + 1,
                        playCount = song.plays ?: 0,
                        isPlaying = playerState.currentSong?.id == song.id,
                        onClick = { playerViewModel.playSong(song) },
                        onMoreClick = { 
                            selectedSong = song
                            showSongOptions = true
                        }
                    )
                    if (index < sortedSongs.size - 1) {
                        HorizontalDivider(
                            modifier = Modifier.padding(horizontal = 8.dp, vertical = 2.dp),
                            color = SurfaceLight,
                            thickness = 0.5.dp
                        )
                    }
                }
                item {
                    Spacer(modifier = Modifier.height(80.dp))
                }
            }
        }
    }
    
    if (showSongOptions && selectedSong != null) {
        LibrarySongOptionsSheet(
            song = selectedSong!!,
            onDismiss = { showSongOptions = false },
            onPlay = { 
                playerViewModel.playSong(selectedSong!!)
                showSongOptions = false
            },
            onPlayNext = { 
                playerViewModel.addToQueue(selectedSong!!, playNext = true)
                showSongOptions = false
            },
            onAddToQueue = { 
                playerViewModel.addToQueue(selectedSong!!)
                showSongOptions = false
            },
            onDownload = { 
                playerViewModel.downloadSong(selectedSong!!)
                showSongOptions = false
            },
            onAddToPlaylist = { 
                showAddToPlaylistDialog = true
                showSongOptions = false
            },
            onRemoveFromLibrary = { 
                libraryViewModel.removeSongFromLibrary(selectedSong!!)
                showSongOptions = false
            },
            onShare = { 
                val sendIntent = Intent().apply {
                    action = Intent.ACTION_SEND
                    putExtra(Intent.EXTRA_TEXT, "Listen to ${selectedSong!!.title} by ${selectedSong!!.artist}")
                    type = "text/plain"
                }
                context.startActivity(Intent.createChooser(sendIntent, "Share Song"))
                showSongOptions = false
            }
        )
    }
}

@Composable
private fun MostPlayedSongItem(
    song: Song,
    rank: Int,
    playCount: Int,
    isPlaying: Boolean,
    onClick: () -> Unit,
    onMoreClick: () -> Unit
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(horizontal = 8.dp, vertical = 4.dp)
            .height(52.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        // Rank badge
        Box(
            modifier = Modifier
                .size(40.dp)
                .background(
                    color = if (rank <= 3) AccentRed else SurfaceLight,
                    shape = RoundedCornerShape(8.dp)
                ),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = "#$rank",
                style = MaterialTheme.typography.labelSmall,
                fontWeight = FontWeight.Bold,
                color = if (rank <= 3) Color.White else TextPrimary
            )
        }
        
        AsyncImage(
            model = song.image,
            contentDescription = song.title,
            modifier = Modifier
                .size(48.dp)
                .clip(RoundedCornerShape(4.dp)),
            contentScale = ContentScale.Crop
        )
        
        Column(
            modifier = Modifier
                .weight(1f)
                .fillMaxHeight(),
            verticalArrangement = Arrangement.Center
        ) {
            Text(
                text = song.title,
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = if (isPlaying) FontWeight.Bold else FontWeight.SemiBold,
                color = if (isPlaying) AccentRed else TextPrimary,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
            Text(
                text = "${song.artist} â€¢ ${playCount} plays",
                style = MaterialTheme.typography.labelSmall,
                color = TextSecondary,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
        }
        
        IconButton(
            onClick = onMoreClick,
            modifier = Modifier.size(32.dp)
        ) {
            Icon(
                imageVector = Icons.Default.MoreVert,
                contentDescription = "Options",
                tint = TextSecondary,
                modifier = Modifier.size(20.dp)
            )
        }
    }
}
